<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor d'horari — sessions.json</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px}
    h1{margin-bottom:8px} h2{margin:12px 0}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px}
    .btn{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .danger{color:#b00020}
    .ok{color:#0a7d2a}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ddd;padding:6px}
    th{background:#f5f5f5}
    select,input[type="time"],input[type="text"]{padding:6px;border:1px solid #ccc;border-radius:6px;width:100%;box-sizing:border-box}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .pill{font-size:.8rem;padding:2px 8px;border:1px solid #ddd;border-radius:999px}
    .muted{color:#666}
    .right{margin-left:auto}
    .nowrap{white-space:nowrap}
    .warn{background:#fff5c2}
    .footer{margin-top:24px}
    .small{font-size:.9em}
    .table-wrap{overflow:auto}
    /* Inline error highlighting */
    td.err{ background:#ffe4e6 !important; }
    td.err input, td.err select{ border-color:#e11d48 !important; background:#fff1f2 !important; }

    /* Icon buttons */
    .iconbtn{border:0;background:#fff;padding:6px;border-radius:8px;cursor:pointer;line-height:0;border:1px solid #ddd}
    .iconbtn:hover{background:#f7f7f7}
    .icon{display:inline-block;vertical-align:middle;fill:currentColor}
    .iconbtn.dup{color:#0a7d2a}    /* verd */
    .iconbtn.del{color:#b00020}    /* vermell */
    .btn.primary{background:#111;color:#fff;border-color:#111}

    /* Dropdown actions */
    .dropdown{position:relative;display:inline-block}
    .dropdown-toggle{padding:8px 12px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
    .dropdown-menu{position:absolute;top:110%;left:0;min-width:240px;background:#fff;border:1px solid #ddd;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.12);padding:8px;display:none;z-index:10}
    .dropdown.open .dropdown-menu{display:block}
    .dropdown-menu .btn, .dropdown-menu label.btn{width:100%;text-align:left;margin:4px 0}
    .dropdown-menu hr{border:none;border-top:1px solid #eee;margin:8px 0}

    /* Slim selects for toolbar */
    #timeMode, #filterMode, #filterSelect { width:auto; min-width: 140px; display:inline-block }

    .timewrap{display:flex;align-items:center;gap:6px}
    .timewrap .btn{padding:6px 8px}
  </style>
</head>
<body>
  <!-- Soft access gate -->
  <div class="gate-overlay" id="gate" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:99999;">
    <div style="background:#fff;border-radius:14px;box-shadow:0 18px 50px rgba(0,0,0,.25);width:min(92vw,420px);padding:18px">
      <div style="font-size:.9rem;color:#666;margin-bottom:6px;letter-spacing:.08em">ACCÉS RESTRINGIT</div>
      <h2 style="margin:0 0 8px 0">Clau d'accés</h2>
      <p class="muted" style="margin:0 0 10px 0">Introdueix la clau per editar l'horari.</p>
      <input id="gateInput" type="password" placeholder="••••••••" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin-bottom:10px">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button id="gateCancel" class="btn">Cancel·la</button>
        <button id="gateOK" class="btn primary">Entra</button>
      </div>
      <div id="gateMsg" style="color:#b00020;margin-top:8px;display:none">Clau incorrecta</div>
    </div>
  </div>

  <h1>Editor de sessions</h1>
  <!-- <p class="muted small">Mantén <code>classes.json</code> i <code>teachers.json</code> com a llista mestra de grups/professors.</p> -->

  <div class="bar">
    <div class="dropdown" id="actionsDropdown">
      <button class="dropdown-toggle">Accions ▾</button>
      <div class="dropdown-menu">
        <button class="btn" id="loadServerBtn">Carrega del servidor</button>
        <hr/>
        <label class="btn">Importa <code>sessions.json</code>
          <input id="fileInput" type="file" accept=".json" style="display:none">
        </label>
        <hr/>
        <button class="btn" id="addRowBtn">Afegeix sessió</button>
        <button class="btn" id="validateBtn">Comprova solapaments</button>
        <button class="btn" id="exportBtn">Descarrega sessions.json</button>
      </div>
    </div>
    <!-- <button class="btn" id="loadServerBtn">Carrega del servidor</button>
    <label class="btn">
      Importa <code>sessions.json</code>
      <input id="fileInput" type="file" accept=".json" style="display:none">
    </label>
    <button class="btn" id="addRowBtn">Afegeix sessió</button>
    <button class="btn" id="exportBtn">Descarrega sessions.json</button>
    <button class="btn" id="validateBtn">Comprova solapaments</button> -->
    <span id="status" class="pill muted"></span>
    <a href="index.html" class="btn right">↩ Torna a la vista</a>
  </div>

  <div class="controls">
    <label>Mode hora:</label>
    <select id="timeMode"><option value="time">Hores HH:MM</option><option value="slots">Franges</option></select>
    <label>Filtra:</label>
    <select id="filterMode">
      <option value="all">Totes</option>
      <option value="class">Per classe</option>
      <option value="teacher">Per professor</option>
    </select>
    <select id="filterSelect"></select>
    <button class="btn" id="clearFilter">Neteja filtre</button>
    <span class="pill muted">Files: <span id="rowCount">0</span></span>
    <span class="pill muted">Avisos: <span id="warnCount">0</span></span>
  </div>

  <div class="table-wrap">
    <table id="table">
      <thead>
        <tr>
          <th>Dia</th>
          <th>Inici</th>
          <th>Fi</th>
          <th>Assignatura</th>
          <th>Classe</th>
          <th>Professor/a</th>
          <th>Aula</th>
          <th class="nowrap">Accions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="report" class="footer"></div>

  <script src="js/admin.js"></script>
  <script src="js/timepicker.js"></script>

  <script>
    // dropdownToggleHandler
    (function(){
      const dd = document.getElementById('actionsDropdown');
      if (!dd) return;
      const toggle = dd.querySelector('.dropdown-toggle');
      toggle.addEventListener('click', (e)=>{
        e.stopPropagation();
        dd.classList.toggle('open');
      });
      document.addEventListener('click', ()=> dd.classList.remove('open'));
    })();
  </script>

  <script>
    // --- Soft access gate (deterrent, not real security on GitHub Pages) ---
    // Change this to the SHA-256 of your chosen passphrase (see tools/hash.html)
    const ADMIN_HASH = "a0fc5ca44fd17293e959146e22fdd3d056c842707ca732b7c67e3d0486426ffd"; // sha256('canvia-ho')
    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    (function gateInit(){
      const ok = localStorage.getItem('admin_ok') === ADMIN_HASH;
      const gate = document.getElementById('gate');
      if (!ok){
        gate.style.display = 'flex';
        const inp = document.getElementById('gateInput');
        const okBtn = document.getElementById('gateOK');
        const cancelBtn = document.getElementById('gateCancel');
        const msg = document.getElementById('gateMsg');
        async function submit(){
          msg.style.display = 'none';
          const h = await sha256Hex(inp.value||"");
          if (h === ADMIN_HASH){
            localStorage.setItem('admin_ok', ADMIN_HASH);
            gate.remove();
          }else{
            msg.style.display = 'block';
            inp.focus(); inp.select();
          }
        }
        okBtn.addEventListener('click', submit);
        inp.addEventListener('keydown', (e)=>{ if (e.key==='Enter') submit(); });
        cancelBtn.addEventListener('click', ()=> history.back());
        setTimeout(()=> inp.focus(), 50);
      }
    })();
  </script>
</body>
</html>
